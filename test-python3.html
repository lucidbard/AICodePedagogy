<!DOCTYPE html>
<html>
<head>
    <title>Python 3 Feature Test</title>
    <script src="vendor/skulpt/skulpt.min.js"></script>
    <script src="vendor/skulpt/skulpt-stdlib.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .test { margin: 10px 0; padding: 10px; background: #222; border-radius: 5px; }
        .pass { border-left: 4px solid #0f0; }
        .fail { border-left: 4px solid #f00; }
        pre { white-space: pre-wrap; margin: 5px 0; }
        h2 { color: #d4af37; }
    </style>
</head>
<body>
    <h1>üêç Python 3 Feature Tests (Skulpt 1.3.0)</h1>
    <div id="results"></div>

    <script>
    const tests = [
        {
            name: "f-strings (basic)",
            code: `name = "Alexandria"
count = 42
print(f"Found {count} fragments in {name}")`,
            expected: "Found 42 fragments in Alexandria"
        },
        {
            name: "f-strings (expressions)",
            code: `x = 10
y = 5
print(f"Sum: {x + y}, Product: {x * y}")`,
            expected: "Sum: 15, Product: 50"
        },
        {
            name: "f-strings (formatting)",
            code: `value = 3.14159
print(f"Pi is approximately {value:.2f}")`,
            expected: "Pi is approximately 3.14"
        },
        {
            name: "Dictionary iteration",
            code: `data = {"a": 1, "b": 2, "c": 3}
for key in data:
    print(f"{key}: {data[key]}")`,
            expected: "a: 1"
        },
        {
            name: "print() function",
            code: `print("Hello", "World", sep="-")`,
            expected: "Hello-World"
        },
        {
            name: "String methods",
            code: `text = "sacred temple"
print(text.startswith("sacred"))
print(text.endswith("temple"))`,
            expected: "True"
        },
        {
            name: "List comprehension",
            code: `squares = [x**2 for x in range(5)]
print(squares)`,
            expected: "[0, 1, 4, 9, 16]"
        },
        {
            name: "Stage 5 code (word frequency with f-strings)",
            code: `words = ["temple", "gold", "temple", "sacred"]
temple_count = 0
for word in words:
    if word == "temple":
        temple_count += 1
print(f"  temple: {temple_count}")`,
            expected: "temple: 2"
        }
    ];

    function runTest(test) {
        return new Promise((resolve) => {
            let output = "";

            Sk.configure({
                output: function(text) { output += text; },
                read: function(x) {
                    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                        throw "File not found: '" + x + "'";
                    return Sk.builtinFiles["files"][x];
                },
                __future__: Sk.python3
            });

            Sk.misceval.asyncToPromise(function() {
                return Sk.importMainWithBody("<test>", false, test.code, true);
            }).then(() => {
                const passed = output.includes(test.expected);
                resolve({
                    name: test.name,
                    passed,
                    output: output.trim(),
                    expected: test.expected,
                    error: null
                });
            }).catch((err) => {
                resolve({
                    name: test.name,
                    passed: false,
                    output: "",
                    expected: test.expected,
                    error: err.toString()
                });
            });
        });
    }

    async function runAllTests() {
        const resultsDiv = document.getElementById("results");
        let passed = 0, failed = 0;

        for (const test of tests) {
            const result = await runTest(test);

            const div = document.createElement("div");
            div.className = `test ${result.passed ? 'pass' : 'fail'}`;

            if (result.passed) {
                passed++;
                div.innerHTML = `<strong>‚úÖ ${result.name}</strong><pre>Output: ${result.output}</pre>`;
            } else {
                failed++;
                div.innerHTML = `<strong>‚ùå ${result.name}</strong>
                    <pre>Expected: ${result.expected}</pre>
                    <pre>Got: ${result.output || result.error}</pre>`;
            }

            resultsDiv.appendChild(div);
        }

        const summary = document.createElement("h2");
        summary.innerHTML = `Results: ${passed}/${tests.length} passed`;
        resultsDiv.insertBefore(summary, resultsDiv.firstChild);
    }

    runAllTests();
    </script>
</body>
</html>
